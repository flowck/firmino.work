---
title: Golang - Generating HTTP handlers from an OpenAPI definition file
date: 2022-12-10 17:14:00
metatags: golang
description: On this blog post I intend to share a step by step guide to generate http handlers from an OpenAPI (Swagger) definition file.
cover: "posts/hong-feng-pi80HXv_ct4-unsplash.webp"
isPublished: false
isArchive: false
---

## Introduction

An attribute of a good software, is its always up-to-date documentation and software systems that expose a REST API or simply an HTTP API can leverage from a well-defined specification to document its endpoints. Despite the myriad of tools to document an API, keeping the documentation up to date can be painful because some of those tools require changes in multiple places, have a complex setup, or require adding special annotations that end up clogging the codebase.

If you are writing systems that expose an REST/HTTP API using Go, you can leverage a tool that will inspect the [OpenAPI](https://swagger.io/specification) specification and use it as the single source of truth, and generate the artifacts necessary for the system you are building, expose its REST/HTTP interface.

In order to achieve what I've described in the paragraph above, I am going to use a tool known as [oapi-codegen](https://github.com/deepmap/oapi-codegen), and I learnt about it from the guys at [ThreeDotsLabs](https://threedots.tech/), and their repository [Wild-workouts-go-ddd-example](https://github.com/ThreeDotsLabs/wild-workouts-go-ddd-example).

> I highly recommend checking ThreeDotsLabs' for high-quality content about building enterprise systems using Go.

# oapi-codegen in action

In the sections that follow, I am going to demonstrate how you can go from a specification file to a Go http server and handlers generated by oapi-codegen, I am also going to use [Chi](https://github.com/go-chi/chi), a lightweight routing library.

> Beside Chi, oapi-codegen supports Echo, Gin and Gorilla, and the integration process doesn't differ that much from the one presented here.

## Step 1: Environment setup

Inside a Go project, open the terminal and type the following command to install oapi-codegen

```
go install github.com/deepmap/oapi-codegen/cmd/oapi-codegen@latest
```

If everything goes well, type `oapi-codegen` in the terminal, and you should see the following message:

```
Please specify a path to a OpenAPI 3.0 spec file
```

## Step 2: Define the Open API specification

Define a location or folder within the project where you would like to store the API definition file. I like the approach used by the guys at ThreeDotsLabs, which is to store it in a folder named `api` in the root of the project: `./api/openapi/openapi.yaml`.

For this blog post, here is the specification containing the endpoints that are expected to be exposed:

[Open the full file](https://github.com/flowck/blog-posts-code-snippets/blob/main/oapi-codegen-demo/api/openapi/openapi.yaml)

```yaml
openapi: 3.0.3
info:
  title: CartService
  description: |-
    CartService
  termsOfService: http://swagger.io/terms/
  contact:
    email: apiteam@swagger.io
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.11
externalDocs:
  description: Find out more about Swagger
  url: http://swagger.io
servers:
  - url: https://petstore3.swagger.io/api/v3
tags:
  - name: product
    description: Products
paths:
  /products:
    post:
      tags:
        - product
      summary: Add a new pet to the store
      description: Add a new pet to the store
      operationId: placeProduct
      requestBody:
        description: Place a product into the cart
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Product"
        required: true
      responses:
        "200":
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
  /products/{id}:
    parameters:
      - name: id
        in: path
        description: Product's id
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - product
      summary: Get a product
      description: Get product by id
      operationId: getProduct
      responses:
        "200":
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
components:
  schemas:
    Product:
      type: object
      properties:
        id:
          type: integer
          format: uuid
          example: d39a6f8f-e62a-4820-8824-c4a7cdde8a20
        name:
          type: string
          example: doggie
        sku:
          type: integer
        title:
          type: string
        description:
          type: string
        style:
          type: string
        price:
          type: number
        currencyId:
          type: string
        currencyFormat:
          type: string
        isFreeShipping:
          type: boolean
      required:
        - sku
        - title
        - description
        - style
        - price
        - currencyId
        - currencyFormat
        - isFreeShipping
  requestBodies:
    Product:
      description: Pet object that needs to be added to the store
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Product"
```

The specification file above, contains the following:

1. An endpoint to create a product [POST] /products.
2. An endpoint to get a product by `id` [GET] /products/{id}.
3. A schema, `Product`, that represents the `struct` that is going to be used to marshal/unmarshal product data.

## Step 3: Generate the server (Chi-based), the types and the swagger specification for validation

Create a folder named `internal` and then run the following command in the terminal:

```sh
oapi-codegen -package internal \
  -generate server,types,spec \
  ./api/openapi/openapi.yaml > ./internal/http_server.gen.go
```

The command above specifies the following:

1. The name of the package where the generated file is going to be written to, in our case, `internal`.
2. The artifacts to be generated: the server, the types and the swagger spec.
3. The source of the Open API definition and the destination of the file to be generated.

After running it, check if the file `http_server.gen.go` has been created in the folder `./internal`, if so, you are going to see the following generated code:

```go
// Package internal provides primitives to interact with the openapi HTTP API.
//
// Code generated by github.com/deepmap/oapi-codegen version v1.12.4 DO NOT EDIT.
package internal

import (
	"bytes"
	"compress/gzip"
	"encoding/base64"
	"fmt"
	"net/http"
	"net/url"
	"path"
	"strings"

	"github.com/deepmap/oapi-codegen/pkg/runtime"
	openapi_types "github.com/deepmap/oapi-codegen/pkg/types"
	"github.com/getkin/kin-openapi/openapi3"
	"github.com/labstack/echo/v4"
)

// Product defines model for Product.
type Product struct {
	CurrencyFormat string  `json:"currencyFormat"`
	CurrencyId     string  `json:"currencyId"`
	Description    string  `json:"description"`
	Id             *int    `json:"id,omitempty"`
	IsFreeShipping bool    `json:"isFreeShipping"`
	Name           *string `json:"name,omitempty"`
	Price          float32 `json:"price"`
	Sku            int     `json:"sku"`
	Style          string  `json:"style"`
	Title          string  `json:"title"`
}

// ServerInterface represents all server handlers.
type ServerInterface interface {
	// Add a new pet to the store
	// (POST /products)
	PlaceProduct(w http.ResponseWriter, r *http.Request)
	// Get a product
	// (GET /products/{id})
	GetProduct(w http.ResponseWriter, r *http.Request, id openapi_types.UUID)
}

//... more code
```

## Step 4: Implement the ServerInterface

In `http_server.gen.go`, an interface named `ServerInterface` was generated, and we need it to ensure that our `http` server correctly implements the handlers based in the Open API spec file.

In the same package, create a file named `http_handlers.go`, and then create a `struct` that is going to be used to implement the interface `ServerInterface`:

```go[class="line-numbers"]
type handlers struct{}
```

To ensure that `handlers` correctly implements `ServerInterface` add the following code in the same file:

```diff-go[class="line-numbers"][class="language-diff-go"][class="diff-highlight"]
  type handlers struct{}

+ var _ ServerInterface = (*handlers)(nil)
```

At this point your editor/IDE should be complaining about the missing methods from `ServerInterface`, so let's add them:

> If you are using GoLand, it is possible to automatically implement interface. Please follow this guide: https://www.jetbrains.com/go/guide/tips/implement-an-interface/

```go
func (h handlers) PlaceProduct(w http.ResponseWriter, r *http.Request) {
	//TODO implement me
	panic("implement me")
}

func (h handlers) GetProduct(w http.ResponseWriter, r *http.Request, id openapi_types.UUID) {
	//TODO implement me
	panic("implement me")
}
```

## Integrating the generated code

## Conclusion
